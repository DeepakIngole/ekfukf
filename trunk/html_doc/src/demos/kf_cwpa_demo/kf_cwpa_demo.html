<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of kf_cwpa_demo</title>
  <meta name="keywords" content="kf_cwpa_demo">
  <meta name="description" content="A very simple demo for the classical Kalman filter and smoother">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">src</a> &gt; <a href="#">demos</a> &gt; <a href="index.html">kf_cwpa_demo</a> &gt; kf_cwpa_demo.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for src/demos/kf_cwpa_demo&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>kf_cwpa_demo
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>A very simple demo for the classical Kalman filter and smoother</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> A very simple demo for the classical Kalman filter and smoother
 using the continous Wiener process acceleration (CWPA) model. 

 Copyright (C) 2007 Jouni Hartikainen

 This software is distributed under the GNU General Public 
 Licence (version 2 or later); please refer to the file 
 Licence.txt, included with the software, for details.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../src/fbf_smooth.html" class="code" title="function [M,P] = fbf_smooth(M,P,Y,A,Q,H,R,use_inf)">fbf_smooth</a>	FBF_SMOOTH  Forward-Backward Filtering Based Smoother</li><li><a href="../../../src/gauss_rnd.html" class="code" title="function X = gauss_rnd(M,S,N)">gauss_rnd</a>	GAUSS_RND  Multivariate Gaussian random variables</li><li><a href="../../../src/kf_predict.html" class="code" title="function [x,P] = kf_predict(x,P,A,Q,B,u)">kf_predict</a>	KF_PREDICT  Perform Kalman Filter prediction step</li><li><a href="../../../src/kf_update.html" class="code" title="function [X,P,K,IM,IS,LH] = kf_update(X,P,y,H,R)">kf_update</a>	KF_UPDATE  Kalman Filter update step</li><li><a href="../../../src/lti_disc.html" class="code" title="function [A,Q] = lti_disc(F,L,Q,dt)">lti_disc</a>	LTI_DISC  Discretize LTI ODE with Gaussian Noise</li><li><a href="../../../src/rts_smooth.html" class="code" title="function [M,P,D] = rts_smooth(M,P,A,Q)">rts_smooth</a>	RTS_SMOOTH  Rauch-Tung-Striebel smoother</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% A very simple demo for the classical Kalman filter and smoother</span>
0002 <span class="comment">% using the continous Wiener process acceleration (CWPA) model.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Copyright (C) 2007 Jouni Hartikainen</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% This software is distributed under the GNU General Public</span>
0007 <span class="comment">% Licence (version 2 or later); please refer to the file</span>
0008 <span class="comment">% Licence.txt, included with the software, for details.</span>
0009 
0010 <span class="comment">% Transition matrix for the continous-time system.</span>
0011 F = [0 0 1 0 0 0;
0012      0 0 0 1 0 0;
0013      0 0 0 0 1 0;
0014      0 0 0 0 0 1;
0015      0 0 0 0 0 0;
0016      0 0 0 0 0 0];
0017 
0018 <span class="comment">% Noise effect matrix for the continous-time system.</span>
0019 L = [0 0;
0020      0 0;
0021      0 0;
0022      0 0;
0023      1 0;
0024      0 1];
0025 
0026 <span class="comment">% Stepsize</span>
0027 dt = 0.5;
0028 
0029 <span class="comment">% Process noise variance</span>
0030 q = 0.2;
0031 Qc = diag([q q]);
0032 
0033 <span class="comment">% Discretization of the continous-time system.</span>
0034 [A,Q] = <a href="../../../src/lti_disc.html" class="code" title="function [A,Q] = lti_disc(F,L,Q,dt)">lti_disc</a>(F,L,Qc,dt);
0035 
0036 <span class="comment">% Measurement model.</span>
0037 H = [1 0 0 0 0 0;
0038      0 1 0 0 0 0;
0039      0 0 1 0 0 0;
0040      0 0 0 1 0 0];
0041 
0042 H = [1 0 0 0 0 0;
0043      0 1 0 0 0 0];
0044 <span class="comment">% Variance in the measurements.</span>
0045 r1 = 10;
0046 r2 = 5;
0047 R = diag([r1 r1 r2 r2]);
0048 R = diag([r1 r1]);
0049 
0050 <span class="comment">% Generate the data.</span>
0051 n = 50;
0052 Y = zeros(size(H,1),n);
0053 X_r = zeros(size(F,1),n);
0054 X_r(:,1) = [0 0 0 0 0 0]';
0055 <span class="keyword">for</span> i = 2:n
0056    X_r(:,i) = A*X_r(:,i-1) + <a href="../../../src/gauss_rnd.html" class="code" title="function X = gauss_rnd(M,S,N)">gauss_rnd</a>(zeros(size(F,1),1), Q);
0057 <span class="keyword">end</span>
0058 
0059 <span class="comment">% Generate the measurements.</span>
0060 <span class="keyword">for</span> i = 1:n
0061    Y(:,i) = H*X_r(:,i) + <a href="../../../src/gauss_rnd.html" class="code" title="function X = gauss_rnd(M,S,N)">gauss_rnd</a>(zeros(size(Y,1),1), R);
0062 <span class="keyword">end</span>
0063 
0064 clf; clc;
0065 disp(<span class="string">'This is a demonstration program for the classical Kalman filter.'</span>);
0066 disp(<span class="string">' '</span>);
0067 disp([<span class="string">'KF is used here to estimate the position of a moving object, whos '</span>,<span class="keyword">...</span>
0068      <span class="string">'dynamics follow the CWPA-model described in the documentation '</span>,<span class="keyword">...</span>
0069       <span class="string">'provided with the toolbox.'</span>]);
0070 disp(<span class="string">' '</span>);
0071 disp([<span class="string">'We get noisy measurements from the objects position and velocity '</span>,<span class="keyword">...</span>
0072       <span class="string">'on discrete time steps. The real position of the object and the '</span>,<span class="keyword">...</span>
0073       <span class="string">'measurements made of them are displayed now. The blue line is the '</span>,<span class="keyword">...</span>
0074       <span class="string">'real path of the object and the green dots represents the '</span>,<span class="keyword">...</span>
0075       <span class="string">'measurements. The red circle represents the starting point '</span>,<span class="keyword">...</span>
0076       <span class="string">'of the object.'</span>]);
0077 
0078 disp(<span class="string">' '</span>);
0079 fprintf(<span class="string">'Filtering with KF...'</span>);
0080 
0081 plot(X_r(1,:),X_r(2,:),Y(1,:),Y(2,:),<span class="string">'.'</span>,X_r(1,1),<span class="keyword">...</span>
0082      X_r(2,1),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,12);
0083 legend(<span class="string">'Real trajectory'</span>, <span class="string">'Measurements'</span>);
0084 title(<span class="string">'Position'</span>);
0085 
0086 <span class="comment">% Uncomment if you want to save an image</span>
0087 <span class="comment">% print -dpsc demo1_f1.ps</span>
0088 
0089 <span class="comment">% Initial guesses for the state mean and covariance.</span>
0090 m = [0 0 0 0 0 0]';
0091 P = diag([0.1 0.1 0.1 0.1 0.5 0.5]);
0092 
0093 <span class="comment">%% Space for the estimates.</span>
0094 MM = zeros(size(m,1), size(Y,2));
0095 PP = zeros(size(m,1), size(m,1), size(Y,2));
0096 
0097 <span class="comment">% Filtering steps.</span>
0098 <span class="keyword">for</span> i = 1:size(Y,2)
0099    [m,P] = <a href="../../../src/kf_predict.html" class="code" title="function [x,P] = kf_predict(x,P,A,Q,B,u)">kf_predict</a>(m,P,A,Q);
0100    [m,P] = <a href="../../../src/kf_update.html" class="code" title="function [X,P,K,IM,IS,LH] = kf_update(X,P,y,H,R)">kf_update</a>(m,P,Y(:,i),H,R);
0101    MM(:,i) = m;
0102    PP(:,:,i) = P;
0103 <span class="keyword">end</span>
0104 
0105 <span class="comment">% Smoothing step.</span>
0106 [SM,SP] = <a href="../../../src/rts_smooth.html" class="code" title="function [M,P,D] = rts_smooth(M,P,A,Q)">rts_smooth</a>(MM,PP,A,Q);
0107 [SM2,SP2] = <a href="../../../src/fbf_smooth.html" class="code" title="function [M,P] = fbf_smooth(M,P,Y,A,Q,H,R,use_inf)">fbf_smooth</a>(MM,PP,Y,A,Q,H,R,1);
0108 
0109 fprintf(<span class="string">'ready.\n'</span>);
0110 disp(<span class="string">' '</span>);
0111 disp(<span class="string">'Push any button to see the results.'</span>);
0112 pause
0113 
0114 subplot(1,2,1);
0115 plot(X_r(1,:), X_r(2,:),<span class="string">'--'</span>, MM(1,:), MM(2,:),X_r(1,1),X_r(2,1),<span class="keyword">...</span>
0116      <span class="string">'o'</span>,<span class="string">'MarkerSize'</span>,12)
0117 legend(<span class="string">'Real trajectory'</span>, <span class="string">'Filtered'</span>);
0118 title(<span class="string">'Position estimation with Kalman filter.'</span>);
0119 xlabel(<span class="string">'x'</span>);
0120 ylabel(<span class="string">'y'</span>);
0121 
0122 subplot(1,2,2);
0123 plot(X_r(3,:), X_r(4,:),<span class="string">'--'</span>, MM(3,:), MM(4,:),X_r(3,1),<span class="keyword">...</span>
0124      X_r(4,1),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,12);
0125 legend(<span class="string">'Real velocity'</span>, <span class="string">'Filtered'</span>);
0126 title(<span class="string">'Velocity estimation with Kalman filter.'</span>);
0127 xlabel(<span class="string">'x^.'</span>);
0128 ylabel(<span class="string">'y^.'</span>);
0129 
0130 <span class="comment">% Uncomment if you want to save an image</span>
0131 <span class="comment">% print -dpsc demo1_f2.ps</span>
0132 
0133 
0134 clc; 
0135 disp([<span class="string">'The filtering results are displayed now. In the left panel the '</span>,<span class="keyword">...</span>
0136       <span class="string">'estimated path is shown, and, for comparison, in the right panel '</span>,<span class="keyword">...</span>
0137       <span class="string">'the estimated velocity is shown.'</span>]);
0138 disp(<span class="string">' '</span>)
0139 disp(<span class="string">'Push any key to see the smoothing results of a RTS smoother'</span>);
0140 
0141 pause
0142 subplot(1,2,1);
0143 plot(X_r(1,:), X_r(2,:),<span class="string">'--'</span>, SM(1,:), SM(2,:),X_r(1,1),<span class="keyword">...</span>
0144      X_r(2,1),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,12);
0145 legend(<span class="string">'Real trajectory'</span>, <span class="string">'Smoothed'</span>);
0146 title(<span class="string">'Position estimation with RTS smoother.'</span>);
0147 xlabel(<span class="string">'x'</span>);
0148 ylabel(<span class="string">'y'</span>);
0149 
0150 subplot(1,2,2);
0151 plot(X_r(3,:), X_r(4,:),<span class="string">'--'</span>, SM(3,:), SM(4,:),X_r(3,1),<span class="keyword">...</span>
0152      X_r(4,1),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,12);
0153 legend(<span class="string">'Real velocity'</span>, <span class="string">'Smoothed'</span>);
0154 title(<span class="string">'Velocity estimation with RTS smoother.'</span>);
0155 xlabel(<span class="string">'x^.'</span>);
0156 ylabel(<span class="string">'y^.'</span>);
0157 
0158 <span class="comment">% Uncomment if you want to save an image</span>
0159 <span class="comment">% print -dpsc demo1_f3.ps</span>
0160 
0161 clc; 
0162 disp([<span class="string">'The smoothing results are displayed now. In the left panel the '</span>,<span class="keyword">...</span>
0163       <span class="string">'estimated path is shown, and, for comparison, in the right panel '</span>,<span class="keyword">...</span>
0164       <span class="string">'the estimated velocity is shown.'</span>]);
0165 disp(<span class="string">' '</span>)
0166 disp(<span class="string">'Push any key to see the filtering results sequentially.'</span>);
0167 
0168 pause
0169 subplot(1,2,1);
0170 plot(X_r(1,:), X_r(2,:),<span class="string">'--'</span>, SM2(1,:), SM2(2,:),X_r(1,1),<span class="keyword">...</span>
0171      X_r(2,1),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,12);
0172 legend(<span class="string">'Real trajectory'</span>, <span class="string">'Smoothed'</span>);
0173 title(<span class="string">'Position estimation with FBF smoother.'</span>);
0174 xlabel(<span class="string">'x'</span>);
0175 ylabel(<span class="string">'y'</span>);
0176 
0177 subplot(1,2,2);
0178 plot(X_r(3,:), X_r(4,:),<span class="string">'--'</span>, SM2(3,:), SM2(4,:),X_r(3,1),<span class="keyword">...</span>
0179      X_r(4,1),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,12);
0180 legend(<span class="string">'Real velocity'</span>, <span class="string">'Smoothed'</span>);
0181 title(<span class="string">'Velocity estimation with FBF smoother.'</span>);
0182 xlabel(<span class="string">'x^.'</span>);
0183 ylabel(<span class="string">'y^.'</span>);
0184 
0185 <span class="comment">% Track and animate the filtering result.</span>
0186 clc
0187 disp([<span class="string">'Filtering result is now displayed sequentially on '</span>,<span class="keyword">...</span>
0188      <span class="string">'every time step.'</span>]);
0189 disp(<span class="string">' '</span>);
0190 disp([<span class="string">'The observations are displayed as green dots and '</span>,<span class="keyword">...</span>
0191      <span class="string">'the real signal as solid blue line. The filtering '</span>,<span class="keyword">...</span>
0192      <span class="string">'result of previous steps is plotted as dashed black '</span>,<span class="keyword">...</span>
0193      <span class="string">'line. The covariance in each step is displayed as a '</span>,<span class="keyword">...</span>
0194      <span class="string">'green ellipse around the mean (black circle) on each '</span>,<span class="keyword">...</span>
0195      <span class="string">'step. The predicted position on next step is displayed '</span>,<span class="keyword">...</span>
0196      <span class="string">'as a red circle'</span>]);
0197 disp(<span class="string">' '</span>);
0198 disp(<span class="string">'Press any to proceed to next step'</span>);
0199 
0200 clf
0201 EST = [];
0202 <span class="keyword">for</span> k=1:size(Y,2)
0203     M = MM(:,k);  
0204     P = PP(:,:,k);
0205     EST = [EST M];
0206     M_pred = <a href="../../../src/kf_predict.html" class="code" title="function [x,P] = kf_predict(x,P,A,Q,B,u)">kf_predict</a>(M,P,A,Q);
0207     
0208     <span class="comment">% Confidence ellipse</span>
0209     tt = (0:0.01:1)*2*pi;
0210     cc = repmat(M(1:2),1,length(tt)) + <span class="keyword">...</span>
0211      2*chol(P(1:2,1:2))'*[cos(tt);sin(tt)];
0212 
0213     <span class="comment">% Animate</span>
0214     plot(X_r(1,:),X_r(2,:),<span class="string">'-'</span>,<span class="keyword">...</span>
0215          Y(1,:), Y(2,:), <span class="string">'.'</span>,<span class="keyword">...</span>
0216          M(1),M(2),<span class="string">'ko'</span>,<span class="keyword">...</span>
0217          M_pred(1),M_pred(2),<span class="string">'ro'</span>,<span class="keyword">...</span>
0218          EST(1,:),EST(2,:),<span class="string">'k--'</span>,<span class="keyword">...</span>
0219      cc(1,:),cc(2,:),<span class="string">'g-'</span>);
0220     drawnow;
0221     pause;
0222 <span class="keyword">end</span>
0223 
0224 <span class="comment">% Smoothing result.</span>
0225 clf; clc;
0226 disp([<span class="string">'Smoothing (using RTS smoother) result is now displayed '</span>,<span class="keyword">...</span>
0227      <span class="string">'sequentially on every time step in reverse order.'</span>]);
0228 disp(<span class="string">' '</span>);
0229 disp([<span class="string">'The observations are displayed as green dots and the '</span>,<span class="keyword">...</span>
0230      <span class="string">'real signal as solid blue line. The smoothing result '</span>,<span class="keyword">...</span>
0231      <span class="string">'of previous steps is plotted as dashed black line.'</span>,<span class="keyword">...</span>
0232      <span class="string">'The covariance in each step is displayed as a green'</span>,<span class="keyword">...</span>
0233      <span class="string">'ellipse around the mean (black circle) on each step.'</span>]);
0234 disp(<span class="string">' '</span>);
0235 disp(<span class="string">'Press any to proceed to next step'</span>);
0236 
0237 EST = [];
0238 <span class="keyword">for</span> k=size(Y,2):-1:1
0239     M = SM(:,k);  
0240     P = SP(:,:,k);
0241     EST = [EST M];
0242 
0243     <span class="comment">% Confidence ellipse</span>
0244     tt = (0:0.01:1)*2*pi;
0245     cc = repmat(M(1:2),1,length(tt)) + <span class="keyword">...</span>
0246      2*chol(P(1:2,1:2))'*[cos(tt);sin(tt)];
0247 
0248     <span class="comment">% Animate</span>
0249     len = 1.5;
0250     plot(X_r(1,:),X_r(2,:),<span class="string">'-'</span>,<span class="keyword">...</span>
0251          Y(1,:),Y(2,:),<span class="string">'.'</span>,<span class="keyword">...</span><span class="comment">         </span>
0252          M(1),M(2),<span class="string">'ko'</span>,<span class="keyword">...</span>
0253          EST(1,:),EST(2,:),<span class="string">'k--'</span>,<span class="keyword">...</span>
0254      cc(1,:),cc(2,:),<span class="string">'g-'</span>);
0255     drawnow;
0256     pause;
0257 <span class="keyword">end</span>
0258 
0259 <span class="comment">% MSEs of position estimates</span>
0260 MSE_KF1 = mean((X_r(1,:)-MM(1,:)).^2);
0261 MSE_KF2 = mean((X_r(2,:)-MM(2,:)).^2);
0262 MSE_KF = 1/2*(MSE_KF1 + MSE_KF2);
0263 
0264 MSE_RTS1 = mean((X_r(1,:)-SM(1,:)).^2);
0265 MSE_RTS2 = mean((X_r(2,:)-SM(2,:)).^2);
0266 MSE_RTS = 1/2*(MSE_RTS1 + MSE_RTS2);
0267 
0268 MSE_FBF1 = mean((X_r(1,:)-SM2(1,:)).^2);
0269 MSE_FBF2 = mean((X_r(2,:)-SM2(2,:)).^2);
0270 MSE_FBF = 1/2*(MSE_FBF1 + MSE_FBF2);
0271 
0272 clc;
0273 fprintf(<span class="string">'Mean square errors of position estimates:\n'</span>);
0274 fprintf(<span class="string">'KF-RMSE = %.4f\n'</span>,MSE_KF);
0275 fprintf(<span class="string">'RTS-RMSE = %.4f\n'</span>,MSE_RTS);
0276 fprintf(<span class="string">'FBF-RMSE = %.4f\n\n'</span>,MSE_FBF);
0277 
0278</pre></div>
<hr><address>Generated on Thu 07-Jun-2007 14:54:42 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>