<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ukfs_bot_demo</title>
  <meta name="keywords" content="ukfs_bot_demo">
  <meta name="description" content="Bearings Only Tracking (BOT) demonstration with UKF.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="#">src</a> &gt; <a href="#">demos</a> &gt; <a href="index.html">bot_demo</a> &gt; ukfs_bot_demo.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for src/demos/bot_demo&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>ukfs_bot_demo
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>Bearings Only Tracking (BOT) demonstration with UKF.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Bearings Only Tracking (BOT) demonstration with UKF.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="bot_h.html" class="code" title="function Y = bot_h(x,s)">bot_h</a>	Azimuth measurement function for EKF/UKF.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% Bearings Only Tracking (BOT) demonstration with UKF.</span>
0002 
0003 <span class="comment">% Copyright (C) 2002, 2003 Simo Särkkä</span>
0004 <span class="comment">%               2007       Jouni Hartikainen</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% This software is distributed under the GNU General Public</span>
0007 <span class="comment">% Licence (version 2 or later); please refer to the file</span>
0008 <span class="comment">% Licence.txt, included with the software, for details.</span>
0009 
0010   keep_trajectory = 0;
0011   silent = 0;
0012   
0013   <span class="comment">% Number of steps to advance at a time in animations.</span>
0014   steps = 2;
0015   
0016   <span class="comment">% Handle to measurement model function</span>
0017   h_func = @<a href="bot_h.html" class="code" title="function Y = bot_h(x,s)">bot_h</a>;
0018 
0019   <span class="comment">% Create a bit curved trajectory and angle</span>
0020   <span class="comment">% measurements from two sensors</span>
0021   S1 = [-1;-2];
0022   S2 = [1;1];
0023   sd = 0.05;
0024   dt = 0.01;
0025   <span class="keyword">if</span> ~keep_trajectory
0026     <span class="comment">% Accelerations for the object.</span>
0027     a = zeros(1,500);
0028     a(1,50:100)  = pi/2/51/dt + 0.01*randn(1,51);
0029     a(1,200:250) = pi/2/51/dt + 0.01*randn(1,51);
0030     a(1,350:400) = pi/2/51/dt + 0.01*randn(1,51);
0031     x = [0;0;1;0];
0032     t = 0;
0033     X = [];
0034     Y = [];
0035     T = [];
0036     <span class="keyword">for</span> i=1:500
0037       F = [0 0  1    0;<span class="keyword">...</span>
0038            0 0  0    1;<span class="keyword">...</span>
0039            0 0  0   a(i);<span class="keyword">...</span>
0040            0 0 -a(i) 0];
0041       x = expm(F*dt)*x;
0042       y1 = atan2(x(2)-S1(2), x(1)-S1(1)) + sd * randn;
0043       y2 = atan2(x(2)-S2(2), x(1)-S2(1)) + sd * randn;
0044       t  = t + dt;
0045       X = [X x];
0046       T = [T t];
0047       Y = [Y [y1;y2]];
0048     <span class="keyword">end</span>
0049   <span class="keyword">end</span>
0050 
0051   <span class="comment">%</span>
0052   <span class="comment">% Initialize UKF to values</span>
0053   <span class="comment">%</span>
0054   <span class="comment">%   x = 0</span>
0055   <span class="comment">%   y = 0,</span>
0056   <span class="comment">%   dx/dt = 0</span>
0057   <span class="comment">%   dy/dt = 0</span>
0058   <span class="comment">%</span>
0059   <span class="comment">% with great uncertainty in velocity</span>
0060   <span class="comment">%</span>
0061   M = [0;0;0;0];
0062   P = diag([0.1 0.1 10 10]);
0063   R = sd^2;
0064   qx = 0.1;
0065   qy = 0.1;
0066   F = [0 0 1 0;
0067        0 0 0 1;
0068        0 0 0 0;
0069        0 0 0 0];
0070   [A,Q] = lti_disc(F,[],diag([0 0 qx qy]),dt);
0071 
0072   clc;  clf;
0073   disp([<span class="string">'In this demonstration we track a moving object with two sensors, '</span>,<span class="keyword">...</span>
0074         <span class="string">'which gives only bearings of the object with respect to sensors position. '</span>,<span class="keyword">...</span>
0075        <span class="string">'The state of the system is estimated with UKF.'</span>])
0076   disp(<span class="string">' '</span>);
0077   fprintf(<span class="string">'Running UKF...'</span>)
0078   <span class="comment">%</span>
0079   <span class="comment">% Track and animate</span>
0080   <span class="comment">%</span>
0081   MM = zeros(size(M,1),size(Y,2));
0082   PP = zeros(size(M,1),size(M,1),size(Y,2));
0083   ME = zeros(size(M,1),1);
0084   <span class="keyword">for</span> k=1:size(Y,2)
0085     <span class="comment">% Track with (nonaugmented) UKF</span>
0086     [M,P] = ukf_predict1(M,P,A,Q);
0087     [M,P] = ukf_update1(M,P,Y(:,k),h_func,R*eye(2),[S1 S2]);
0088     MM(:,k)   = M;
0089     PP(:,:,k) = P;
0090     ME(k) = P(1,1) + P(2,2);
0091   <span class="keyword">end</span>
0092   ukf_rmse = sqrt(mean((X(1,:)-MM(1,:)).^2+(X(2,:)-MM(2,:)).^2));
0093 
0094   fprintf(<span class="string">'Done!\n'</span>)
0095   disp(<span class="string">' '</span>);
0096   disp([<span class="string">'The filtering results are now displayed sequentially. '</span>,<span class="keyword">...</span>
0097        <span class="string">'Notice how the estimates gets more accurate when the filter gets on the right track. '</span>,<span class="keyword">...</span>
0098        <span class="string">'The green ellipse around the current estimate (little blue circle) reflects the filters '</span>,<span class="keyword">...</span>
0099        <span class="string">'confidence intervals of the position estimate.'</span>]);
0100   disp(<span class="string">' '</span>);
0101   disp(<span class="string">'&lt;push any key to proceed&gt;'</span>);
0102 
0103   <span class="comment">% Plot the filtered estimates sequentially</span>
0104   <span class="keyword">if</span> ~silent
0105       M = MM(:,1);  
0106       P = PP(:,:,1);
0107       EST = M;
0108       tt = (0:0.01:1)*2*pi;
0109       cc = repmat(M(1:2),1,length(tt)) + <span class="keyword">...</span>
0110               2*chol(P(1:2,1:2))'*[cos(tt);sin(tt)];
0111       h = plot(X(1,:),X(2,:),<span class="string">'r-'</span>,<span class="keyword">...</span>
0112                M(1),M(2),<span class="string">'bo'</span>,<span class="keyword">...</span>
0113                EST(1,:),EST(2,:),<span class="string">'b--'</span>,<span class="keyword">...</span>
0114                cc(1,:),cc(2,:),<span class="string">'g-'</span>,<span class="keyword">...</span>
0115                S1(1),S1(2),<span class="string">'k--'</span>,<span class="keyword">...</span>
0116                S1(1),S1(2),<span class="string">'k^'</span>,<span class="keyword">...</span>
0117                S2(1),S2(2),<span class="string">'k--'</span>,<span class="keyword">...</span>
0118                S2(1),S2(2),<span class="string">'k^'</span>);
0119       legend(<span class="string">'Location'</span>,<span class="string">'NorthWest'</span>,<span class="string">'Real trajectory'</span>,<span class="string">'Current estimate'</span>,<span class="string">'Estimated trajectory'</span>,<span class="keyword">...</span>
0120              <span class="string">'Confidence interval'</span>,<span class="string">'Measurements from sensors'</span>,<span class="string">'Positions of the sensors'</span>);
0121       title(<span class="string">'Bearings Only Tracking with UKF.'</span>)
0122       axis([-1.5 1.5 -2.5 1.5]);
0123       
0124       EST = [];
0125       <span class="keyword">for</span> k=1:steps:size(Y,2)
0126         M = MM(:,k);
0127         P = PP(:,:,k);
0128         EST = MM(:,1:k);
0129 
0130         <span class="comment">% Confidence ellipse</span>
0131         cc = repmat(M(1:2),1,length(tt)) + <span class="keyword">...</span>
0132          2*chol(P(1:2,1:2))'*[cos(tt);sin(tt)];
0133 
0134         <span class="comment">% Measurement directions</span>
0135         len = 2.5;
0136         dx1 = len*cos(Y(1,k));
0137         dy1 = len*sin(Y(1,k));
0138         dx2 = len*cos(Y(2,k));
0139         dy2 = len*sin(Y(2,k));
0140 
0141         <span class="comment">% Update graphics</span>
0142         set(h(2),<span class="string">'xdata'</span>,M(1)); set(h(2),<span class="string">'ydata'</span>,M(2));
0143         set(h(3),<span class="string">'xdata'</span>,EST(1,:)); set(h(3),<span class="string">'ydata'</span>,EST(2,:)); 
0144         set(h(4),<span class="string">'xdata'</span>,cc(1,:)); set(h(4),<span class="string">'ydata'</span>,cc(2,:)); 
0145         set(h(5),<span class="string">'xdata'</span>,[S1(1);S1(1)+dx1]); set(h(5),<span class="string">'ydata'</span>,[S1(2);S1(2)+dy1]); 
0146         set(h(7),<span class="string">'xdata'</span>,[S2(1);S2(1)+dx2]); set(h(7),<span class="string">'ydata'</span>,[S2(2);S2(2)+dy2]); 
0147       pause
0148     <span class="keyword">end</span>
0149   <span class="keyword">end</span>
0150   
0151   clc;
0152   disp([<span class="string">'In this demonstration we track a moving object with two sensors, '</span>,<span class="keyword">...</span>
0153         <span class="string">'which gives only bearings of the object with respect to sensors position. '</span>,<span class="keyword">...</span>
0154        <span class="string">'The state of the system is estimated with UKF.'</span>])
0155   disp(<span class="string">' '</span>);
0156   fprintf(<span class="string">'Running UKF...Done!\n'</span>)
0157   disp(<span class="string">' '</span>);
0158   disp([<span class="string">'The filtering results are now displayed sequentially. '</span>,<span class="keyword">...</span>
0159        <span class="string">'Notice how the estimates gets more accurate when the filter gets on the right track. '</span>,<span class="keyword">...</span>
0160        <span class="string">'The green ellipse around the current estimate (little blue circle) reflects the filters '</span>,<span class="keyword">...</span>
0161        <span class="string">'confidence intervals of the position estimate.'</span>]);
0162   disp(<span class="string">' '</span>);
0163   disp(<span class="string">'&lt;push any key to smooth the estimates with URTS and UTF&gt;'</span>);
0164   pause;
0165   clc;
0166   fprintf(<span class="string">'Smoothing with URTS and UTF...'</span>);
0167 
0168   <span class="comment">% Smoothing with URTS</span>
0169   [SM1,SP1] = urts_smooth1(MM,PP,A,Q);
0170   uks_rmse1 = sqrt(mean((X(1,:)-SM1(1,:)).^2+(X(2,:)-SM1(2,:)).^2));
0171   ME1 = squeeze(SP1(1,1,:)+SP1(2,2,:));
0172   
0173   <span class="comment">% Smoothing with UTF</span>
0174   IAW = inv(A)*[eye(size(A,1)) eye(size(A,1))];
0175   [SM2,SP2] = utf_smooth1(MM,PP,Y,IAW,Q,[],<span class="keyword">...</span>
0176              h_func,R*eye(2),[S1 S2]);
0177   uks_rmse2 = sqrt(mean((X(1,:)-SM2(1,:)).^2+(X(2,:)-SM2(2,:)).^2));
0178   ME2 = squeeze(SP2(1,1,:)+SP2(2,2,:));
0179 
0180   fprintf(<span class="string">'Done!\n'</span>)
0181   disp(<span class="string">' '</span>);
0182   disp([<span class="string">'Smoothing results of URTS are now displayed sequentially. '</span>,<span class="keyword">...</span>
0183         <span class="string">'Notice how the confidence ellipse gets even smaller now.'</span>]);
0184   disp(<span class="string">' '</span>);
0185   disp(<span class="string">'&lt;push any key to proceed&gt;'</span>);
0186   
0187   <span class="comment">% Plot the smoothed estimates sequentially</span>
0188   <span class="keyword">if</span> ~silent
0189     M = SM1(:,1);  
0190     P = SP1(:,:,1);
0191     EST = M;
0192     cc = repmat(M(1:2),1,length(tt)) + <span class="keyword">...</span>
0193      2*chol(P(1:2,1:2))'*[cos(tt);sin(tt)];
0194     h = plot(X(1,:),X(2,:),<span class="string">'r-'</span>,<span class="keyword">...</span>
0195              M(1),M(2),<span class="string">'o'</span>,<span class="keyword">...</span>
0196              EST(1,:),EST(2,:),<span class="string">'--'</span>,<span class="keyword">...</span>
0197              cc(1,:),cc(2,:),<span class="string">'g-'</span>,<span class="keyword">...</span>
0198              MM(1,:),MM(2,:),<span class="string">'b--'</span>,<span class="keyword">...</span>
0199              S1(1),S1(2),<span class="string">'k^'</span>,S2(1),S2(2),<span class="string">'k^'</span>);
0200     legend(<span class="string">'Location'</span>,<span class="string">'NorthWest'</span>,<span class="string">'Real trajectory'</span>,<span class="string">'Current estimate'</span>,<span class="string">'Smoothed trajectory'</span>,<span class="keyword">...</span>
0201            <span class="string">'Confidence interval'</span>,<span class="string">'Filter estimate'</span>,<span class="string">'Positions of the sensors'</span>);
0202     title(<span class="string">'Bearings Only Tracking with URTS.'</span>)
0203     axis([-1.5 1.5 -2.5 1.5]);
0204     EST = [];
0205     <span class="keyword">for</span> k=size(Y,2):-steps:1
0206       M = SM1(:,k);  
0207       P = SP1(:,:,k);
0208       EST = SM1(:,end:-1:k);
0209 
0210       <span class="comment">% Confidence ellipse</span>
0211       cc = repmat(M(1:2),1,length(tt)) + <span class="keyword">...</span>
0212      2*chol(P(1:2,1:2))'*[cos(tt);sin(tt)];
0213 
0214       <span class="comment">% Update graphics</span>
0215       set(h(2),<span class="string">'xdata'</span>,M(1)); set(h(2),<span class="string">'ydata'</span>,M(2));
0216       set(h(3),<span class="string">'xdata'</span>,EST(1,:)); set(h(3),<span class="string">'ydata'</span>,EST(2,:)); 
0217       set(h(4),<span class="string">'xdata'</span>,cc(1,:)); set(h(4),<span class="string">'ydata'</span>,cc(2,:)); 
0218       pause;
0219      <span class="keyword">end</span>
0220   <span class="keyword">end</span>
0221   
0222   disp(<span class="string">' '</span>)
0223   disp(<span class="string">'&lt;push any key to display all estimates together&gt;'</span>)
0224   pause;
0225   clc;
0226   disp(<span class="string">'All estimates are now displayed.'</span>)
0227   
0228   <span class="comment">%</span>
0229   <span class="comment">% Plot all the estimates together</span>
0230   <span class="comment">%</span>
0231   <span class="keyword">if</span> ~silent
0232     plot(X(1,:),X(2,:),<span class="string">'k-'</span>,<span class="keyword">...</span>
0233          MM(1,:),MM(2,:),<span class="string">'b--'</span>,<span class="keyword">...</span>
0234          SM1(1,:),SM1(2,:),<span class="string">'r-.'</span>,<span class="keyword">...</span>
0235          SM2(1,:),SM2(2,:),<span class="string">'g-.'</span>,<span class="keyword">...</span>
0236          S1(1),S1(2),<span class="string">'k^'</span>,S2(1),S2(2),<span class="string">'k^'</span>);
0237     axis([-1.5 1.5 -2.5 1.5]);
0238     legend(<span class="string">'Real trajectory'</span>,<span class="keyword">...</span>
0239            <span class="string">'UKF estimate'</span>,<span class="keyword">...</span>
0240            <span class="string">'URTS estimate'</span>,<span class="keyword">...</span>
0241            <span class="string">'UTF estimate'</span>,<span class="keyword">...</span>
0242            <span class="string">'Positions of sensors'</span>,<span class="keyword">...</span>
0243            <span class="string">'Location'</span>, <span class="string">'NorthWest'</span>);
0244     title(<span class="string">'Filtering and smoothing result with UKF, URTS and UTF.'</span>);
0245     <span class="comment">% Uncomment if you want to save an image</span>
0246     <span class="comment">%print -dpsc bot_demo_ukf.ps</span>
0247   <span class="keyword">end</span>
0248   
0249   <span class="comment">% Print RMSE</span>
0250   disp(<span class="string">' '</span>);
0251   disp(<span class="string">'RMS errors:'</span>);
0252   fprintf(<span class="string">'UKF-RMSE  = %.3f  [%.3f]\n'</span>,ukf_rmse,sqrt(mean(ME)));  
0253   fprintf(<span class="string">'URTS-RMSE = %.4f [%.4f]\n'</span>,uks_rmse1,sqrt(mean(ME1)));  
0254   fprintf(<span class="string">'UTF-RMSE = %.4f [%.4f]\n'</span>,uks_rmse2,sqrt(mean(ME2)));</pre></div>
<hr><address>Generated on Mon 06-Aug-2007 15:19:02 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>