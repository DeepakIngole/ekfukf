<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ekfs_bot_demo</title>
  <meta name="keywords" content="ekfs_bot_demo">
  <meta name="description" content="Bearings Only Tracking (BOT) demonstration with EKF">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="#">src</a> &gt; <a href="#">demos</a> &gt; <a href="index.html">bot_demo</a> &gt; ekfs_bot_demo.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for src/demos/bot_demo&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>ekfs_bot_demo
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>Bearings Only Tracking (BOT) demonstration with EKF</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Bearings Only Tracking (BOT) demonstration with EKF</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="bot_d2h_dx2.html" class="code" title="function dY = bot_d2h_dx2(x,s)">bot_d2h_dx2</a>	Hessian of the measurement function in BOT-demo.</li><li><a href="bot_dh_dx.html" class="code" title="function dY = bot_dh_dx(x,s)">bot_dh_dx</a>	Jacobian of the measurement model function in BOT demo.</li><li><a href="bot_h.html" class="code" title="function Y = bot_h(x,s)">bot_h</a>	Azimuth measurement function for EKF/UKF.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% Bearings Only Tracking (BOT) demonstration with EKF</span>
0002 
0003 <span class="comment">% Copyright (C) 2002 Simo Särkkä</span>
0004 <span class="comment">%               2007 Jouni Hartikainen</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% This software is distributed under the GNU General Public</span>
0007 <span class="comment">% Licence (version 2 or later); please refer to the file</span>
0008 <span class="comment">% Licence.txt, included with the software, for details.</span>
0009 
0010   keep_trajectory = 0;
0011   silent = 0;
0012   
0013   <span class="comment">% Number of steps to advance at a time in animations.</span>
0014   steps = 2;
0015   
0016   <span class="comment">% Handles to measurement model function and it's derivatives</span>
0017   h_func = @<a href="bot_h.html" class="code" title="function Y = bot_h(x,s)">bot_h</a>;
0018   dh_dx_func = @<a href="bot_dh_dx.html" class="code" title="function dY = bot_dh_dx(x,s)">bot_dh_dx</a>;
0019   d2h_dx2_func = @<a href="bot_d2h_dx2.html" class="code" title="function dY = bot_d2h_dx2(x,s)">bot_d2h_dx2</a>;
0020 
0021   <span class="comment">% Create a bit curved trajectory and angle</span>
0022   <span class="comment">% measurements from two sensors</span>
0023   S1 = [-1;-2];
0024   S2 = [1;1];
0025   sd = 0.05;
0026   dt = 0.01;
0027   <span class="keyword">if</span> ~keep_trajectory
0028     <span class="comment">% Accelerations for the object</span>
0029     a = zeros(1,500);
0030     a(1,50:100)  = pi/2/51/dt + 0.01*randn(1,51);
0031     a(1,200:250) = pi/2/51/dt + 0.01*randn(1,51);
0032     a(1,350:400) = pi/2/51/dt + 0.01*randn(1,51);
0033     x = [0;0;1;0];
0034     t = 0;
0035     X = [];
0036     Y = [];
0037     T = [];
0038     <span class="keyword">for</span> i=1:500
0039       F = [0 0  1    0;<span class="keyword">...</span>
0040            0 0  0    1;<span class="keyword">...</span>
0041            0 0  0   a(i);<span class="keyword">...</span>
0042            0 0 -a(i) 0];
0043       x = expm(F*dt)*x;
0044       y1 = atan2(x(2)-S1(2), x(1)-S1(1)) + sd * randn;
0045       y2 = atan2(x(2)-S2(2), x(1)-S2(1)) + sd * randn;
0046       t  = t + dt;
0047       X = [X x];
0048       T = [T t];
0049       Y = [Y [y1;y2]];
0050     <span class="keyword">end</span>
0051   <span class="keyword">end</span>
0052   
0053   <span class="comment">% Uncomment if you want to plot and print the measurements</span>
0054   <span class="comment">%plot(1:size(Y,2),Y(1,:),'.',1:size(Y,2),Y(2,:),'.');</span>
0055   <span class="comment">%legend('Sensor 1', 'Sensor 2');</span>
0056   <span class="comment">%title('Measurements from sensors in radians');</span>
0057   <span class="comment">%print -dpsc bot_demo_measurements.ps</span>
0058 
0059   <span class="comment">%</span>
0060   <span class="comment">% Initialize EKF to values</span>
0061   <span class="comment">%</span>
0062   <span class="comment">%   x = 0</span>
0063   <span class="comment">%   y = 0,</span>
0064   <span class="comment">%   dx/dt = 0</span>
0065   <span class="comment">%   dy/dt = 0</span>
0066   <span class="comment">%</span>
0067   <span class="comment">% with great uncertainty in velocity</span>
0068   <span class="comment">%</span>
0069   M = [0;0;0;0];
0070   P = diag([4 4 4 4]);
0071   R = sd^2;
0072   <span class="keyword">if</span> ~silent
0073     der_check(h_func, dh_dx_func, 1, M, S1);
0074     der_check(h_func, dh_dx_func, 1, M, S2);
0075   <span class="keyword">end</span>
0076   qx = 0.1;
0077   qy = 0.1;
0078   F = [0 0 1 0;
0079        0 0 0 1;
0080        0 0 0 0;
0081        0 0 0 0];
0082   [A,Q] = lti_disc(F,[],diag([0 0 qx qy]),dt);
0083 
0084   clc;
0085   clf;
0086   disp([<span class="string">'In this demonstration we track a moving object with two sensors, '</span>,<span class="keyword">...</span>
0087         <span class="string">'which gives only bearings of the object with respect to sensors position.'</span>,<span class="keyword">...</span>
0088        <span class="string">'The state of the system is estimated with EKF.'</span>])
0089   disp(<span class="string">' '</span>);
0090   fprintf(<span class="string">'Running EKF...'</span>)
0091   
0092   <span class="comment">%</span>
0093   <span class="comment">% Track and animate</span>
0094   <span class="comment">%</span>
0095   MM = zeros(size(M,1),size(Y,2));
0096   PP = zeros(size(M,1),size(M,1),size(Y,2));
0097   ME = zeros(size(M,1),1);
0098   <span class="keyword">for</span> k=1:size(Y,2)
0099     <span class="comment">% Track with EKF</span>
0100     [M,P] = ekf_predict1(M,P,A,Q);
0101     [M,P] = ekf_update1(M,P,Y(:,k),dh_dx_func,R*eye(2),h_func,[],[S1 S2]);
0102     MM(:,k)   = M;
0103     PP(:,:,k) = P;
0104     ME(k) = P(1,1) + P(2,2);
0105   <span class="keyword">end</span>
0106   ekf_rmse = sqrt(mean((X(1,:)-MM(1,:)).^2+(X(2,:)-MM(2,:)).^2));
0107 
0108   fprintf(<span class="string">'Done!\n'</span>)
0109   disp(<span class="string">' '</span>);
0110   disp([<span class="string">'The filtering results are now displayed sequentially. '</span>,<span class="keyword">...</span>
0111        <span class="string">'Notice how the estimates gets more accurate when the filter gets on the right track. '</span>,<span class="keyword">...</span>
0112        <span class="string">'The green ellipse around the current estimate (little blue circle) reflects the filters '</span>,<span class="keyword">...</span>
0113        <span class="string">'confidence intervals of the position estimate.'</span>]);
0114   disp(<span class="string">' '</span>);
0115   disp(<span class="string">'&lt;push any key to proceed&gt;'</span>);
0116   
0117   <span class="comment">% Plot the filtered estimates sequentially</span>
0118   <span class="keyword">if</span> ~silent
0119       M = MM(:,1);  
0120       P = PP(:,:,1);
0121       EST = M;
0122       tt = (0:0.01:1)*2*pi;
0123       cc = repmat(M(1:2),1,length(tt)) + <span class="keyword">...</span>
0124               2*chol(P(1:2,1:2))'*[cos(tt);sin(tt)];
0125       h = plot(X(1,:),X(2,:),<span class="string">'r-'</span>,<span class="keyword">...</span>
0126                M(1),M(2),<span class="string">'bo'</span>,<span class="keyword">...</span>
0127                EST(1,:),EST(2,:),<span class="string">'b--'</span>,<span class="keyword">...</span>
0128                cc(1,:),cc(2,:),<span class="string">'g-'</span>,<span class="keyword">...</span>
0129                S1(1),S1(2),<span class="string">'k--'</span>,<span class="keyword">...</span>
0130                S1(1),S1(2),<span class="string">'k^'</span>,<span class="keyword">...</span>
0131                S2(1),S2(2),<span class="string">'k--'</span>,<span class="keyword">...</span>
0132                S2(1),S2(2),<span class="string">'k^'</span>);
0133       legend(<span class="string">'Location'</span>,<span class="string">'NorthWest'</span>,<span class="string">'Real trajectory'</span>,<span class="string">'Current estimate'</span>,<span class="string">'Estimated trajectory'</span>,<span class="keyword">...</span>
0134              <span class="string">'Confidence interval'</span>,<span class="string">'Measurements from sensors'</span>,<span class="string">'Positions of the sensors'</span>);
0135       title(<span class="string">'Bearings Only Tracking with EKF.'</span>)
0136       axis([-1.5 1.5 -2.5 1.5]);
0137       
0138       EST = [];
0139       <span class="keyword">for</span> k=1:steps:size(Y,2)
0140         M = MM(:,k);
0141         P = PP(:,:,k);
0142         EST = MM(:,1:k);
0143 
0144         <span class="comment">% Confidence ellipse</span>
0145         cc = repmat(M(1:2),1,length(tt)) + <span class="keyword">...</span>
0146          2*chol(P(1:2,1:2))'*[cos(tt);sin(tt)];
0147 
0148         <span class="comment">% Measurement directions</span>
0149         len = 2.5;
0150         dx1 = len*cos(Y(1,k));
0151         dy1 = len*sin(Y(1,k));
0152         dx2 = len*cos(Y(2,k));
0153         dy2 = len*sin(Y(2,k));
0154 
0155         <span class="comment">% Update graphics</span>
0156         set(h(2),<span class="string">'xdata'</span>,M(1)); set(h(2),<span class="string">'ydata'</span>,M(2));
0157         set(h(3),<span class="string">'xdata'</span>,EST(1,:)); set(h(3),<span class="string">'ydata'</span>,EST(2,:)); 
0158         set(h(4),<span class="string">'xdata'</span>,cc(1,:)); set(h(4),<span class="string">'ydata'</span>,cc(2,:)); 
0159         set(h(5),<span class="string">'xdata'</span>,[S1(1);S1(1)+dx1]); set(h(5),<span class="string">'ydata'</span>,[S1(2);S1(2)+dy1]); 
0160         set(h(7),<span class="string">'xdata'</span>,[S2(1);S2(1)+dx2]); set(h(7),<span class="string">'ydata'</span>,[S2(2);S2(2)+dy2]); 
0161       pause
0162     <span class="keyword">end</span>
0163   <span class="keyword">end</span>
0164   
0165   clc;
0166   disp([<span class="string">'In this demonstration we track a moving object with two sensors, '</span>,<span class="keyword">...</span>
0167         <span class="string">'which gives only bearings of the object with respect to sensors position.'</span>,<span class="keyword">...</span>
0168        <span class="string">'The state of the system is estimated with EKF.'</span>])
0169   disp(<span class="string">' '</span>);
0170   fprintf(<span class="string">'Running EKF...Done!\n'</span>)
0171   disp(<span class="string">' '</span>);
0172   disp([<span class="string">'The filtering results are now displayed sequentially. '</span>,<span class="keyword">...</span>
0173        <span class="string">'Notice how the estimates gets more accurate when the filter gets on the right track. '</span>,<span class="keyword">...</span>
0174        <span class="string">'The green ellipse around the current estimate (little blue circle) reflects the filters '</span>,<span class="keyword">...</span>
0175        <span class="string">'confidence intervals of the position estimate.'</span>]);
0176   disp(<span class="string">' '</span>);
0177   disp(<span class="string">'&lt;push any key to smooth the estimates with ERTS and ETF&gt;'</span>);
0178   pause;
0179   clc;
0180   fprintf(<span class="string">'Smoothing with ERTS and ETF...'</span>);
0181 
0182   <span class="comment">%</span>
0183   <span class="comment">% Smoother 1</span>
0184   <span class="comment">%</span>
0185   [SM1,SP1] = erts_smooth1(MM,PP,A,Q);
0186   eks_rmse1 = sqrt(mean((X(1,:)-SM1(1,:)).^2+(X(2,:)-SM1(2,:)).^2));
0187   ME1 = squeeze(SP1(1,1,:)+SP1(2,2,:));
0188 
0189 
0190   <span class="comment">%</span>
0191   <span class="comment">% Smoother 2</span>
0192   <span class="comment">%</span>
0193   [SM2,SP2] = etf_smooth1(MM,PP,Y,A,Q,[],[],[],<span class="keyword">...</span>
0194              dh_dx_func,R*eye(2),h_func,[],[S1 S2]);
0195   eks_rmse2 = sqrt(mean((X(1,:)-SM2(1,:)).^2+(X(2,:)-SM2(2,:)).^2));
0196   ME2 = squeeze(SP2(1,1,:)+SP2(2,2,:));
0197 
0198   fprintf(<span class="string">'Done!\n'</span>)
0199   disp(<span class="string">' '</span>);
0200   disp([<span class="string">'Smoothing results of ERTS are now displayed sequentially. '</span>,<span class="keyword">...</span>
0201         <span class="string">'Notice how the confidence ellipse gets even smaller now.'</span>]);
0202   disp(<span class="string">' '</span>);
0203   disp(<span class="string">'&lt;push any key to proceed&gt;'</span>);
0204   
0205   <span class="comment">% Plot the smoothed estimates sequentially</span>
0206   <span class="keyword">if</span> ~silent
0207     M = SM1(:,1);  
0208     P = SP1(:,:,1);
0209     EST = M;
0210     cc = repmat(M(1:2),1,length(tt)) + <span class="keyword">...</span>
0211      2*chol(P(1:2,1:2))'*[cos(tt);sin(tt)];
0212     h = plot(X(1,:),X(2,:),<span class="string">'r-'</span>,<span class="keyword">...</span>
0213              M(1),M(2),<span class="string">'o'</span>,<span class="keyword">...</span>
0214              EST(1,:),EST(2,:),<span class="string">'--'</span>,<span class="keyword">...</span>
0215              cc(1,:),cc(2,:),<span class="string">'g-'</span>,<span class="keyword">...</span>
0216              MM(1,:),MM(2,:),<span class="string">'b--'</span>,<span class="keyword">...</span>
0217              S1(1),S1(2),<span class="string">'k^'</span>,S2(1),S2(2),<span class="string">'k^'</span>);
0218     legend(<span class="string">'Location'</span>,<span class="string">'NorthWest'</span>,<span class="string">'Real trajectory'</span>,<span class="string">'Current estimate'</span>,<span class="string">'Smoothed trajectory'</span>,<span class="keyword">...</span>
0219            <span class="string">'Confidence interval'</span>,<span class="string">'Filter estimate'</span>,<span class="string">'Positions of the sensors'</span>);
0220     title(<span class="string">'Bearings Only Tracking with ERTS.'</span>)
0221     axis([-1.5 1.5 -2.5 1.5]);
0222     EST = [];
0223     <span class="keyword">for</span> k=size(Y,2):-steps:1
0224       M = SM1(:,k);  
0225       P = SP1(:,:,k);
0226       EST = SM1(:,end:-1:k);
0227 
0228       <span class="comment">% Confidence ellipse</span>
0229       cc = repmat(M(1:2),1,length(tt)) + <span class="keyword">...</span>
0230      2*chol(P(1:2,1:2))'*[cos(tt);sin(tt)];
0231       
0232       set(h(2),<span class="string">'xdata'</span>,M(1)); set(h(2),<span class="string">'ydata'</span>,M(2));
0233       set(h(3),<span class="string">'xdata'</span>,EST(1,:)); set(h(3),<span class="string">'ydata'</span>,EST(2,:)); 
0234       set(h(4),<span class="string">'xdata'</span>,cc(1,:)); set(h(4),<span class="string">'ydata'</span>,cc(2,:)); 
0235       pause;
0236      <span class="keyword">end</span>
0237   <span class="keyword">end</span>
0238   
0239   disp(<span class="string">' '</span>)
0240   disp(<span class="string">'&lt;push any key to display all estimates together&gt;'</span>)
0241   pause;
0242   clc;
0243   disp(<span class="string">'All estimates are now displayed.'</span>)
0244 
0245   <span class="comment">%</span>
0246   <span class="comment">% Plot all the estimates together</span>
0247   <span class="comment">%</span>
0248   <span class="keyword">if</span> ~silent
0249     plot(X(1,:),X(2,:),<span class="string">'k-'</span>,<span class="keyword">...</span>
0250          MM(1,:),MM(2,:),<span class="string">'b--'</span>,<span class="keyword">...</span>
0251          SM1(1,:),SM1(2,:),<span class="string">'r-.'</span>,<span class="keyword">...</span>
0252          SM2(1,:),SM2(2,:),<span class="string">'g-.'</span>,<span class="keyword">...</span>
0253          S1(1),S1(2),<span class="string">'k^'</span>,S2(1),S2(2),<span class="string">'k^'</span>);
0254     axis([-1.5 1.5 -2.5 1]);
0255     legend(<span class="string">'Real trajectory'</span>,<span class="keyword">...</span>
0256            <span class="string">'EKF1 estimate'</span>,<span class="keyword">...</span>
0257            <span class="string">'ERTS estimate'</span>,<span class="keyword">...</span>
0258            <span class="string">'ETF estimate'</span>,<span class="keyword">...</span>
0259            <span class="string">'Positions of sensors'</span>,<span class="keyword">...</span>
0260            <span class="string">'Location'</span>, <span class="string">'NorthWest'</span>);
0261     title(<span class="string">'Filtering and smoothing result with 1st order EKF'</span>);
0262     axis([-1.5 1.5 -2.5 1.5]);
0263     <span class="comment">% Uncomment if you want to save an image</span>
0264     <span class="comment">%print -dpsc bot_demo_ekf1.ps</span>
0265   <span class="keyword">end</span>
0266   
0267   <span class="comment">% Print RMSE</span>
0268   disp(<span class="string">' '</span>);
0269   disp(<span class="string">'RMS errors:'</span>);
0270   fprintf(<span class="string">'EKF-RMSE  = %.3f  [%.3f]\n'</span>,ekf_rmse,sqrt(mean(ME)));
0271   fprintf(<span class="string">'EKS-RMSE1 = %.4f [%.4f]\n'</span>,eks_rmse1,sqrt(mean(ME1)));
0272   fprintf(<span class="string">'EKS-RMSE2 = %.4f [%.4f]\n'</span>,eks_rmse2,sqrt(mean(ME2)));</pre></div>
<hr><address>Generated on Mon 06-Aug-2007 15:19:02 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>